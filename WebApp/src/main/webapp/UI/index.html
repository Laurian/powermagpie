<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="#stylesheet" type="text/css"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN" "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html	version="XHTML+RDFa 1.0"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:foaf="http://xmlns.com/foaf/0.1/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xml:lang="en-GB">
  <head	version="XHTML+RDFa 1.0"
        profile="http://www.w3.org/1999/xhtml/vocab">
    <base href="http://localhost:8080/PowerMagpie/" />
    <title>PowerMagpie</title>
    <meta property="dc:creator" content="Laurian Gridinoc" />
    <link rel="transformation" href="http://www.w3.org/2003/g/glean-profile" />

    <link rel="stylesheet" type="text/css" href="Frameworks/ExtJS/2.2.1/resources/css/ext-all.css" />
    <link rel="stylesheet" type="text/css" href="Frameworks/ExtJS/2.2.1/resources/css/xtheme-gray.css" />
 	<script type="text/javascript" src="Frameworks/ExtJS/2.2.1/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="Frameworks/ExtJS/2.2.1/ext-all.js"></script>

    <script type='text/javascript' src='dwr/interface/PowerMagpie.js'></script>
    <script type='text/javascript' src='dwr/engine.js'></script>

    <style id="stylesheet" type="text/css" media="screen, projection"><!--/*--><![CDATA[/*><!--*/
    /*]]>*/--></style>
    <script type="text/javascript"><!--//--><![CDATA[//><!--

var viewport;
var nttRoot;
var ontRoot;
var pontRoot;
var annRoot;

Ext.onReady(function(){

       dwr.engine.setRpcType(dwr.engine.XMLHttpRequest);
       dwr.engine.setActiveReverseAjax(true);

       Ext.state.Manager.setProvider(new Ext.state.CookieProvider());
       viewport = new Ext.Viewport({
            layout:'border',
            items:[
                {
                    region:'south',
                    contentEl: 'south',
                    split:true,
                    height: 100,
                    minSize: 100,
                    maxSize: 200,
                    collapsible: true,
                    autoScroll:true,
                    title:'Details',
                    margins:'0 0 0 0'
                }, {
                    region:'center',
                    deferredRender:false,
                    layout:'accordion',
                    layoutConfig:{
                        animate:true
                    },
                    items:[{
                        title: 'Entities',
                        autoScroll:true,
                        items:[
                            new Ext.tree.TreePanel( {
                                id: 'ntt-tree',
                                animate:true,
                                containerScroll: true,
                                rootVisible: false,
                                root: new Ext.tree.TreeNode({
                                    id: 'ntt-root',
                                    text: 'Entities',
                                    allowDrag:false,
                                    allowDrop:false
                                })
                            })]
                    },{
                        title: 'Ontologies',
                        autoScroll:true,
                        items:[
                            new Ext.tree.TreePanel( {
                                id: 'ont-tree',
                                animate:true,
                                containerScroll: true,
                                rootVisible: false,
                                root: new Ext.tree.TreeNode({
                                    id: 'ont-root',
                                    text: 'Ontologies',
                                    allowDrag:false,
                                    allowDrop:false
                                })
                            })]
                    },{
                        title: 'Predefined Ontologies',
                        autoScroll:true,
                        contentEl: 'visualisation',
                        items:[
                            new Ext.tree.TreePanel( {
                                id: 'pont-tree',
                                animate:true,
                                containerScroll: true,
                                rootVisible: false,
                                root: new Ext.tree.TreeNode({
                                    id: 'pont-root',
                                    text: 'Predefined Ontologies',
                                    allowDrag:false,
                                    allowDrop:false
                                })
                            })]
                    },{
                        title: 'Annotations',
                        autoScroll:true,
                        contentEl: 'annot',
                        items:[
                            new Ext.tree.TreePanel( {
                                id: 'ann-tree',
                                animate:true,
                                containerScroll: true,
                                rootVisible: false,
                                root: new Ext.tree.TreeNode({
                                    id: 'ann-root',
                                    text: 'Annotations',
                                    allowDrag:false,
                                    allowDrop:false
                                })
                            })]
                    }]
                }
             ]
        });

    // setup
    nttRoot = viewport.findById("ntt-tree").getRootNode();
    ontRoot = viewport.findById("ont-tree").getRootNode();
    pontRoot = viewport.findById("pont-tree").getRootNode();
    annRoot = viewport.findById("ann-tree").getRootNode();

    nttRoot.getOwnerTree().on('click', function(n){
        //alert(parent.location.href);
        if(n.attributes.onclick){
            eval(n.attributes.onclick);
        }
    });

    ontRoot.getOwnerTree().on('click', function(n){
        if(n.attributes.onclick){
            eval(n.attributes.onclick);
        }
    });

    pontRoot.getOwnerTree().on('click', function(n){
        if(n.attributes.onclick){
            eval(n.attributes.onclick);
        }
    });

    annRoot.getOwnerTree().on('click', function(n){
        if(n.attributes.onclick){
            eval(n.attributes.onclick);
        }
    });

    // load
    PowerMagpie.getEntities({
        callback:   function(data){
                        populateEntities(data);
                    }
    });

    PowerMagpie.getOntologies({
        callback:   function(data){
                        populateOntologies(data);
                    }
    });

    //predefined ontologies
    populatePOntologies([
        'http://www.example.org/food.owl',
        'http://vistology.com/ont/mad_cows_ont.daml'
    ]);

});

//////////// callbacks ///////////


/////////// entities

function populateEntities(data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        if (nttRoot.findChild("id", "ntt:" + data[i]) != null) continue;
        nttRoot.appendChild(
                new Ext.tree.TreeNode({
                    text:   data[i],
                    id:     "ntt:" + data[i],
                    cls:    'entity',
                    icon:   "Icons/T.png",
                    allowDrag:  false,
                    populated:  false,
                    onclick:    "callExpandTerm('"+data[i]+"')"
                    })
            );
        nttRoot.expand();
    }
}


function callExpandTerm(name) {
    PowerMagpie.send("host", "hi:" + name);
    var node = nttRoot.getOwnerTree().getNodeById("ntt:" + name);
    if (node.populated) return;
    PowerMagpie.expandTerm(name, {
        callback:   function(data){
                        expandTerm(node, data);
                    }
    });
}

function expandTerm(node, data) {

    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        icon = "Icons/" + "R.png";
        if (data[i].type == 'Individual') icon = "Icons/" + "I.png";
        if (data[i].type == 'Class') icon = "Icons/" + "C.png";
        if (data[i].type == 'Property') icon = "Icons/" + "P.png";
        node.appendChild(
                new Ext.tree.TreeNode({
                    text: data[i].localName + " <img onclick='tag(\""+node.id + ":ntt:" + data[i].URI+"\")' src='Icons/mini_icons2/tag.gif' />",
                    id: node.id + ":ntt:" + data[i].URI,
                    cls:'entity',
                    icon: icon,
                    allowDrag:false,
                    populated: false,
                    //checked: false,
                    //oncheck: "checkOne('"+node.id+"', '"+data[i].URI+"')",
                    onclick: "callExpandEntity('"+node.id+":ntt:"+data[i].URI+"', '"+data[i].URI+"', '"+data[i].type+"')"
                    })
            );

        node.expand();
        node.populated = true;

    }

    node.appendChild(
                new Ext.tree.TreeNode({
                    text: "<i>occurences</i>",
                    id: node.id + "@occ:",
                    cls:'entity',
                    icon: "Icons/M.png",
                    allowDrag:false,
                    populated: false
                })
       );

    //notify parent
    //PowerMagpie.send(session + '#pm', node.id);
}

function callExpandEntity(id, uri, type) {
    //TODO
    callInfoEntity(uri);
    var node = nttRoot.getOwnerTree().getNodeById(id);
    if (node.populated) return;

    icon = "Icons/" + "R.png";
    if (type == 'Individual') icon = "Icons/" + "I.png";
    if (type == 'Class') icon = "Icons/" + "C.png";
    if (type == 'Property') icon = "Icons/" + "P.png";

    node.appendChild(
                new Ext.tree.TreeNode({
                    text:uri,
                    id: node.id + "@uri",
                    cls:'entity',
                    icon: icon,
                    allowDrag:false,
                    populated: false
                })
            );

    var ontNode = new Ext.tree.TreeNode({
                    text:"ontologies",
                    id: node.id + ":ont:",
                    cls:'entity',
                    icon: "Icons/R.png",
                    allowDrag:false,
                    populated: false//,
                    //onclick: "callExpandEntity('"+node.id+":ont:"+data[i]+"', '"+data[i]+"')"
                    });
    node.appendChild(ontNode);

    node.expand();
    node.populated = true;

    PowerMagpie.expandEntity(uri, {
        callback:   function(data){
                        expandEntity(ontNode, data);
                    }
    });
}

function expandEntity(node, data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        node.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i].URI + " <img onclick='switch2onto(\""+data[i].URI+"\")' src='Icons/mini_icons2/arrow_right.gif' />",
                    id: node.id + ":ont:" + data[i].URI,
                    cls:'entity',
                    icon: "Icons/R.png",
                    allowDrag:false,
                    populated: false//,
                    //onclick: "callInfoOntology('"+data[i].URI+"');"
                    })
            );
        node.expand();
        node.populated = true;
    }
}

function switch2onto(uri) {
    var node = ontRoot.getOwnerTree().getNodeById('ont:' + uri);
    node.select();
    node.expand();
    node.ensureVisible();
}

/////////// ontologies

function populateOntologies(data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        if (ontRoot.findChild("id", "ont:" + data[i]) != null) continue;
        ontRoot.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i],
                    id: "ont:" + data[i],
                    cls:'entity',
                    icon: "Icons/R.png",
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandOnt('"+data[i]+"')"
                    })
            );
        ontRoot.expand();
    }
}

function populatePOntologies(data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        if (pontRoot.findChild("id", "pont:" + data[i]) != null) continue;
        pontRoot.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i],
                    id: "pont:" + data[i],
                    cls:'entity',
                    icon: "Icons/R.png",
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandPOnt('"+data[i]+"')"
                    })
            );
        pontRoot.expand();
    }
}

function callExpandOnt(uri) {
    // TODO
    //callInfoOntology(uri);
    var node = ontRoot.getOwnerTree().getNodeById("ont:" + uri);

    var sNode = new Ext.tree.TreeNode({
                    text:"All concepts",
                    id: node.id + ":s:",
                    cls:'entity',
                    //icon: "Icons/R.png",
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandOntTop('"+uri+"')"
                    });
    node.appendChild(sNode);

    if (node.populated) return;
    PowerMagpie.expandOnt(uri, {
        callback:   function(data){
                        expandOnt(node, data);
                    }
    });
}

function callExpandPOnt(uri) {
    // TODO
    //callInfoOntology(uri);
    var node = pontRoot.getOwnerTree().getNodeById("pont:" + uri);

    var sNode = new Ext.tree.TreeNode({
                    text:"All concepts",
                    id: node.id + ":s:",
                    cls:'entity',
                    //icon: "Icons/R.png",
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandPOntTop('"+uri+"')"
                    });
    node.appendChild(sNode);
    
    // removed matches list
}

function callExpandOntTop(uri) {
    var node = ontRoot.getOwnerTree().getNodeById("ont:" + uri + ":s:");
    PowerMagpie.expandOntTop(uri, {
        callback:   function(data){
                        expandOntConcepts(node, data);
                    }
    });
}

function callExpandPOntTop(uri) {
    var node = pontRoot.getOwnerTree().getNodeById("pont:" + uri + ":s:");
    PowerMagpie.expandOntTop(uri, {
        callback:   function(data){
                        expandPOntConcepts(node, data);
                    }
    });
}

function callExpandOntClass(id, ont, uri) {
    var node = ontRoot.getOwnerTree().getNodeById(id);
    PowerMagpie.expandOntClass(ont, uri, {
        callback:   function(data){
                        expandOntConcepts(node, data);
                    }
    });
}

function callExpandPOntClass(id, ont, uri) {
    var node = pontRoot.getOwnerTree().getNodeById(id);
    PowerMagpie.expandOntClass(ont, uri, {
        callback:   function(data){
                        expandPOntConcepts(node, data);
                    }
    });
}

function expandOntConcepts(node, data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        icon = "Icons/" + "R.png";
        if (data[i].type == 'Individual') icon = "Icons/" + "I.png";
        if (data[i].type == 'Class') icon = "Icons/" + "C.png";
        if (data[i].type == 'Property') icon = "Icons/" + "P.png";
        node.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i].localName + " <img onclick='tag(\""+node.id + ":xo:" + data[i].URI+"\")' src='Icons/mini_icons2/tag.gif' />",
                    id: node.id + ":xo:" + data[i].URI,
                    cls:'entity',
                    icon: icon,
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandOntClass('"+node.id+":xo:"+data[i].URI+"', '"+data[i].ont+"', '"+data[i].URI+"')"
                    })
            );
        node.expand();
        node.populated = true;
    }
}

function expandPOntConcepts(node, data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        icon = "Icons/" + "R.png";
        if (data[i].type == 'Individual') icon = "Icons/" + "I.png";
        if (data[i].type == 'Class') icon = "Icons/" + "C.png";
        if (data[i].type == 'Property') icon = "Icons/" + "P.png";
        node.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i].localName,
                    id: node.id + ":xo:" + data[i].URI,
                    cls:'entity',
                    icon: icon,
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandPOntClass('"+node.id+":xo:"+data[i].URI+"', '"+data[i].ont+"', '"+data[i].URI+"')"
                    })
            );
        node.expand();
        node.populated = true;
    }
}

function expandOnt(node, data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        icon = "Icons/" + "R.png";
        if (data[i].type == 'Individual') icon = "Icons/" + "I.png";
        if (data[i].type == 'Class') icon = "Icons/" + "C.png";
        if (data[i].type == 'Property') icon = "Icons/" + "P.png";
        node.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i].localName,
                    id: node.id + ":ntt:" + data[i].URI,
                    cls:'entity',
                    icon: icon,
                    allowDrag:false,
                    populated: false,
                    onclick: "callExpandOntEntity('"+node.id+":ntt:"+data[i].URI+"', '"+data[i].URI+"', '"+data[i].type+"')"
                    })
            );
        node.expand();
        node.populated = true;
    }
}


function callExpandOntEntity(id, uri, type) {

    // TODO
    callInfoEntity(uri);

    var node = ontRoot.getOwnerTree().getNodeById(id);
    if (node.populated) return;

    icon = "Icons/" + "R.png";
    if (type == 'Individual') icon = "Icons/" + "I.png";
    if (type == 'Class') icon = "Icons/" + "C.png";
    if (type == 'Property') icon = "Icons/" + "P.png";

    node.appendChild(
                new Ext.tree.TreeNode({
                    text:uri,
                    id: node.id + "@uri",
                    cls:'entity',
                    icon: icon,
                    allowDrag:false,
                    populated: false,
                    onclick: "callInfoEntity('"+uri+"');"
                })
            );

    node.expand();
    node.populated = true;

    PowerMagpie.expandOntEntity(uri, {
        callback:   function(data){
                        expandOntEntity(node, data);
                    }
    });
}

function expandOntEntity(node, data) {
    for (i in data) {
        if ((data[i] + "").indexOf("function (") != -1) continue;
        node.appendChild(
                new Ext.tree.TreeNode({
                    text:data[i] + " <img onclick='switch2term(\""+data[i]+"\")' src='Icons/mini_icons2/arrow_right.gif' />",
                    id: node.id + ":term:" + data[i],
                    cls:'entity',
                    icon: "Icons/T.png",
                    allowDrag:false,
                    populated: false
                    })
            );
        node.expand();
        node.populated = true;
    }
}

function switch2term(t) {
    _select('*', t);
}


//////// messaging
function message(to, msg) {
    //TODO use "to"
    if (msg.indexOf("term:", 0) != -1) {
        PowerMagpie.getEntities({
        callback:   function(data){
                        populateEntities(data);
                    }
        });
    }
}

function _match(to, searchTerm, match, count) {
    //if (to != session + "#ui") return;
    var node = nttRoot.getOwnerTree().getNodeById("ntt:" + searchTerm + "@occ:");
    node.appendChild(
                new Ext.tree.TreeNode({
                    text: match,
                    id: "nid:" + count,
                    cls:'entity',
                    icon: "Icons/M.png",
                    allowDrag:false,
                    populated: false,
                    onclick: "callShowMatch('nid:"+count+"')"
                })
       );

        node.expand();
        node.populated = true;
}

function callShowMatch(nid) {
    PowerMagpie.send('host', nid);
}

function _select(to, searchTerm) {
    //if (to != session + "#ui") return;
    var node = nttRoot.getOwnerTree().getNodeById("ntt:" + searchTerm);
    node.select();
    node.expand();
    node.ensureVisible();
}

function _selectNode(to, id) {
    var node = nttRoot.getOwnerTree().getNodeById(id);
    node.select();
    node.expand();
    node.ensureVisible();
}

function tag(uri) {
    PowerMagpie.send("host", "tag:" + uri);
}

// INFO

function callInfoEntity(uri) {
    //alert(parent.location.href);
    //PowerMagpie.infoEntity(uri, {callback: function(data){infoEntity(data)}});
}

function infoEntity(data) {
    //document.location.hash = "select:" + data;
    document.getElementById('south').innerHTML = "URI <a href='"+data["URI"]+"' target='_new'>" + data["URI"] + "</a><"+"br "+"/>"
        + "Label " + data["label"] + "<"+"br "+"/>"
        + "Comment " + data["comment"] + "<"+"br "+"/>"
        + "Type " + data["type"] + "<"+"br "+"/>"
        //+ "Properties " + data["P"] + ", "
        //+ "Instances " + data["I"]
        + "<"+"br "+"/>"
        + "<a href='http://watson.kmi.open.ac.uk/WatsonWUI/entity_look_up.html#"+escape(data["URI"])+"' target='_new'>Explore further in Watson</a>";
}

function callInfoOntology(uri) {
    //PowerMagpie.infoOntology(uri, {callback: function(data){infoOntology(data)}});
}

function infoOntology(data) {
    document.getElementById('south').innerHTML = "URI <a href='"+data["URI"]+"' target='_new'>" + data["URI"] + "</a><"+"br "+"/>"
        + "DL Expressivity " + data["DL"] + "<"+"br "+"/>"
        + "Languages " + data["lang"] + "<"+"br "+"/>"
        + "Size " + data["size"] + " bytes<"+"br "+"/>"
        //+ "Classes " + data["C"] + ", "
        //+ "Properties " + data["P"] + ", "
        //+ "Instances " + data["I"]
        + "<"+"br "+"/>"
        + "<a href='http://watson.kmi.open.ac.uk/WatsonWUI/onto_check.html?q="+escape(data["URI"])+"' target='_new'>Explore further in Watson</a>";
}

function _tagged(nid, term, uri, node) {
        if (annRoot.findChild("id", "ann:" + nid) != null) return;
        annRoot.appendChild(
                new Ext.tree.TreeNode({
                    text:   term,
                    id:     "ann:" + nid,
                    cls:    'entity',
                    icon:   "Icons/T.png",
                    allowDrag:  false,
                    populated:  false//,
                    //onclick:    "callExpandTerm('"+data[i]+"')"
                    })
            );
        annRoot.expand();
}
    //--><!]]></script>
  </head>
  <body>

  <div id="center2">
      <!-- Ontologies -->
  </div>

  <div id="center1">
      <!-- Entities -->
  </div>

  <div id="south">
    <!-- info -->
    ...
  </div>

  <div id="visualisation">
      
  </div>

  <div id="annot">
      
  </div>
  
  </body>
</html>
